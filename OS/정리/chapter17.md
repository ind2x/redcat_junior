# 태스크 개념을 추가해 멀티태스를 구현하자

<br>

멀티 태스킹의 개념과 원리, 기반이 되는 함수를 작성 및 테스트하는 챕터

<br><br>
<hr style="border: 2px solid;">
<br><br>

## 태스크, 멀티태스킹, 성능 향상

<br>

멀티태스킹은 멀티 + 태스크 로 여러 개의 태스크를 동시에 실행한다는 뜻이다.

태스크는 프로세서 관점으로 본 작업의 단위이며, 독립된 상태와 영역을 가진다. -> 코드, 데이터, 컨텍스트(태스크의 개별정보 -> 레지스터 등) 등을 가지고 있다는 의미

<br>

멀티태스킹을 하기 위해서는 태스크별로 개별적인 컨텍스트를 보장을 해줘야 한다.

즉, 태스크를 완전히 독립시켜야하는데 문제는 프로세서의 상태(컨텍스트)를 개별적으로 할당하는 것만으로는 부족하다.

왜냐하면 x86계열은 코드가 실행되면 데이터(복귀 주소 등등)을 스택에 저장하는데, 스택이 구분되지 않는다면 문제가 발생하게 되기 때문이다.

<br>

태스크에 의존적인 정보를 담는 스택과 컨텍스트를 제외한 코드, 데이터 영역은 다른 태스크와 공통된 부분이 있을 것이다.

그래서 공통된 부분은 같이 쓰게끔 하고 스택과 컨텍스트는 확실하게 구분시켜준다면 멀티태스킹을 할 수 있게 된다.

<br>

![image](https://user-images.githubusercontent.com/52172169/200830835-42dc1268-93a2-4a3b-ba99-06c177e889ff.png)

<br>

멀티태스킹은 여러 개의 태스크가 CPU를 동시에 사용하는 것처럼 보일 수 있지만, 실제로는 아주 짧은 시간동안 사용하고 소유권이 계속 넘어가는 것이다.

여기서 일정 시간 이후 강제로 소유권을 넘겨버리는 것을 **시분할 멀티태스킹**이라고 하고, 우리는 이 방법을 사용한다.

<br>

멀티태스킹을 사용하는 이유는 두 가지가 있다.

첫 번쨰는, 응답 시간이 빠르다는 것으로 순차적으로 태스크를 처리하게 되면 하나를 처리하는 동안 나머지 태스크들은 응답을 대기하게 되는데, 멀티태스킹을 한다면 순차적으로 처리할 때보다 조금 더 시간이 걸리더라고 각각의 태스크 별로 응답 시간은 단축이 되므로 응답이 빠르다는 장점이 생긴다.

두 번째는, 하나의 태스크가 CPU를 100% 이용하는 것이 아니므로 이 시간을 활용하여 전체적인 처리량을 높이고자 하는 것이다.

<br><br>
<hr style="border: 2px solid;">
<br><br>

## 태스크 제어 블록과 태스크 전환 구현

<br>

TCB(Task Control Block)은 태스크의 종합적인 정보가 들어있는 자료구조이다.

TCB에 각 태스크의 상태를 그대로 반영하는 만큼, TCB는 생성된 태스크와 반드시 하나씩만 연결되어야 한다.

이번장에서는 ID나 플래그보다는 컨텍스트 위주로 TCB를 살펴볼 것이고, 컨텍스트는 레지스터를 저장한 것이므로 이와 관련된 자료구조와 매크로 값을 생성해준다.

<br>

태스크 생성은 TCB 생성이란 말과 같다.

태스크의 코드, 데이터, 스택이 모두 준비되었다면 TCB를 생성해주면 되는데, 중요한 것은 넘겨받은 정보를 컨텍스트의 정확한 오프셋에 채워넣는 것이다.

초기화 과정은 코드를 살펴보거나 p.593을 확인

<br>

이제 핵심인 태스크 전환 과정은 크게 두 가지로 나눠볼 수 있는데, 태스크를 저장하는 과정과 태스크를 복원하는 과정으로 볼 수 있다.



<br><br>
<hr style="border: 2px solid;">
<br><br>
