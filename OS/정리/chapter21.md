# 멀티쓰레딩 기능을 추가하자

<br>

스레드, 프로세스는 태스크와 거의 비슷한 말로, 기존의 태스크를 조금만 수정해주면 멀티쓰레드, 프로세스를 지원할 수 있다.

그럴려면 프로세스, 쓰레드, 태스크의 공통점과 차이점을 알아야 한다.

<br>

먼저 프로그램과 프로세스에 대해 알아야 한다.

프로그램은 메모리에 로드하여 실행할 수 있는 코드와 데이터의 집합체이며, 메모리에 로드되기 전에는 단순한 데이터 쪼가리에 불과하다.

이 프로그램이 메모리에 로드되어 실행 가능한 상태가 되면 바로 **프로세스**가 되는 것이다. 

즉, **메모리에 로드된 프로그램 == 프로세스**이다.

이 프로세스에 프로세서(CPU)가 할당되면 실행이 되며, 프로세스는 독립된 공간을 갖게 되어 여러 프로세스가 실행되어도 서로 영향을 주지 않는다.

이런 **여러 프로세스가 동시에 실행되는 것**을 **멀티태스킹**이라고 한다.

<br>

프로세스의 내부에는 실제 프로세서를 할당받아 코드를 실행하는 실행 단위가 존재하는데, 이런 개별적인 실행 단위를 **쓰레드**라고 하며 프로그램이 메모리에 로드될 때 쓰레드도 같이 생성된다.

쓰레드의 장점이자 단점은 프로세스와 메모리를 공유(콘텍스트, 스택 제외)한다는 점으로, 쓰레드 사이의 데이터 전달이 빠르다.

하지만 단점은 어느 한 쓰레드에 문제가 생겨 메모리를 파괴시켜버리면 프로세스 전체에 영향이 가게 된다는 점이다.

<br>

![image](https://user-images.githubusercontent.com/52172169/203709544-675d01e0-9fe1-4318-8e69-a0a86a7aa1db.png)

<br>

**메인 쓰레드**가 **프로세스가 메모리에 로드될 때 같이 할당되는 쓰레드**이며, 서브 쓰레드는 메인 쓰레드 실행 도중 반복되는 코드나 오래 걸리는 코드를 처리할 때 생성되는 쓰레드이다.

즉, **서브 쓰레드는 메인 쓰레드의 부하를 줄이고 효율적인 작업을 위해 생성되는 쓰레드**이다.

<br>

**멀티쓰레딩을 적용할 때 고려해야 되는 부분**은 **프로세스 종료 처리**와 **동기화** 부분이다.

우선 프로세스 종료에 대한 부분을 살펴보면 **메인 쓰레드는 프로세스가 종료되면 같이 종료되며, 종료된다 함은 프로세스의 메모리 영역이 없어진다**라는 뜻이다.

단일 쓰레드에서는 상관 없지만 멀티쓰레드 환경에서는 **문제가 발생**되는데, 바로 **메인 쓰레드가 종료되었음에도 서브 쓰레드가 살아있는 경우**이다.

해제된 메모리 영역에서 문제가 발생하면 그나마 낫지만, 메모리 영역이 해제되고 다른 프로세스가 해당 메모리 영역을 사용하는 경우에 그 영역에서 서브 쓰레드가 실행되고 있다면 예상할 수 없는 문제가 발생하게 된다.

따라서 **메인 쓰레드는 다른 서브 쓰레드가 모두 종료되기 전까지 절대 종료되어선 안된다.**

<br>

동기화 부분은 훨씬 더 중요하며 당연히 전체 프로세스를 공유하는 멀티쓰레드에서 동기화는 매우 중요하다.

공유 메모리에 접근하는 코드가 임계 영역이 되므로 이 부분에서 동기화 처리를 해주면 된다.

<br><br>
<hr style="border: 2px solid;">
<br><br>

## 멀티 쓰레딩 지원을 위한 재설계와 구현

<br>



<br><br>
<hr style="border: 2px solid;">
<br><br>
