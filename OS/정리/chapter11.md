# 키보드 디바이스 드리이버 추가
## 키보드 컨트롤러의 구조와 기능

<br>

![image](https://user-images.githubusercontent.com/52172169/196896404-7d4f1ff8-2e0c-48a0-81fe-cfe1a99b5ccd.png)

<br>

![image](https://user-images.githubusercontent.com/52172169/196896598-873a84b5-770f-4dc4-9489-7b9a13e5caab.png)

<br>

레지스터의 크기는 모두 **1바이트**이며, 그 중 **상태 레지스터는 가장 중요한 레지스터**로, 키보드 컨트롤러에 값을 읽고 쓰려면 반드시 체크해야 하는 비트를 포함하고 있다.

아래가 그 비트들이다.

<br>

![image](https://user-images.githubusercontent.com/52172169/196896619-96beecdc-d269-4841-93da-7b563a86d37e.png)

<br>

![image](https://user-images.githubusercontent.com/52172169/196896661-d6a483d2-90f4-4391-acd8-074aff22db3f.png)

<br><br>
<hr style="border: 2px solid;">
<br><br>

## 키보드 컨트롤러 제어
### 키보드와 키보드 컨트롤러 활성화

<br>

우선 기본적으로 BIOS에 의해 키보드가 활성화되므로 굳이 해주지 않아도 되는데, 혹시 모르니까 해준다.

키보드를 활성화시켜주려면 커맨드 포트 키보드 디바이스를 활성화한다는 의미의 0xAE 를 보낸다. (위의 키보드 컨트롤러 커맨드 확인)

그러나 이것이 키보드 컨트롤러가 활성화 된 것이지 **키보드가 활성화 된 것은 아니다.**

따라서 키보드 자체에도 활성화한다고 보내야 하는데, 입력 버퍼에 직접 키보드 커맨드를 보내주면 된다. (아래 사진 확인)

키보드는 컨트롤러와 달리 응답 값을 보내주는데, ACK(0xFA)를 보내주므로 이를 통해 확인하여 오지 않았다면 재시도를 하거나 중단해야 한다.

<br>

![image](https://user-images.githubusercontent.com/52172169/196907526-d8d1ff7d-59a4-4f51-9d7e-7c797878b0c2.png)

<br>

그래서 활성화 해주려면 키보드 컨트롤러에 0xAE를 보내주면 되는데, 문제는 컨트롤러는 CPU와 달리 처리속도가 상대적으로 느리다.

우리는 키보드에도 명령을 보내줘야 하므로 **상태 레지스터**를 통해 입력 버퍼와 출력 버퍼의 상태를 확인하여 값이 없으면 보내고 값이 있다면 읽어오도록 처리해줌으써 효율적으로 처리할 수 있다.

<br><br>

### IA-32e 모드 함수 호출 규약

<br>

보호모드와의 차이점을 중심으로 보면 다음과 같다.

64비트는 알다시피 레지스터에 인자 값을 받아오며 실수 값의 경우에 XMM0 ~ XMM7 레지스터에 값을 받아오고, 왼쪽부터 오른쪽으로 순서대로 받아온다.

보호모드는 오른쪽에서 왼쪽 순으로 스택으로 인자 값을 받아온다.

또한 64비트는 리턴 값을 RAX 또는 XMM0에 받아오고, 보호모드는 EAX 레지스터로 받아온다.

<br><br>

### 키보드 컨트롤러에서 값 읽기

<br>

단순히 출력 버퍼에 먼저 값이 있는지 확인한 후, 데이터가 있으면 읽어서 반환해주면 된다.

<br>

![image](https://user-images.githubusercontent.com/52172169/196941794-c07848e3-96b8-4a03-9ea5-e2a673c93b4f.png)

<br><br>

### A20 게이트 활성화와 프로세스 리셋

<br>

출력 포트와 관련된 명령은 위의 사진의 컨트롤러 커맨드를 확인해보면 0xD0, 0xD1이 있다.

A20 게이트 비트와 프로세스 리셋 비트는 출력 포트의 비트 1과 0에 있다.

따라서 컨트롤러의 입력 버퍼를 통해 값을 1 또는 0으로 주면 된다.

<br><br>

### 키보드 LED 상태 제어

<br>



<br><br>

<br><br>
<hr style="border: 2px solid;">
<br><br>
