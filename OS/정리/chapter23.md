# 메모리를 내 마음대로 할당받자

<br>

파트 5는 동적 메모리, 파일 시스템을 구현할 것이며 이번 장은 동적 메모리 부분이다.

<br><br>
<hr style="border: 2px solid;">
<br><br>

## 메모리 단편화와 버디 블록 알고리즘

<br>

메모리 단편화는 메모리가 작은 영역으로 조각난 상태를 뜻한다.

<br>

![image](https://user-images.githubusercontent.com/52172169/203921674-9afda3c2-a95e-4a73-b824-3c4b2df89bbd.png)

<br>

위의 사진처럼 메모리가 연속적이지 않고 부분 부분 조각난 것을 볼 수 있는데, 위의 상황은 **외부 단편화**이다.

외부 단편화는 **부분 부분으로 나뉘어져있어 메모리를 할당할 수 없는 상태**이다.

이 메모리 단편화를 해결하기 위해 나온 알고리즘 중 하나가 버디 블록 알고리즘이다.

<br>

해당 알고리즘은 메모리 할당/해제 시 인접한 블록을 합쳐 상위 블록으로 만들거나 상위 블록을 나누어 하위 블록 그룹으로 만든다.

메모리 할당 시 요청된 크기와 인접한 블록에서 검색을 하고, 해제 시에는 인접한 블록과 합치기 때문에 외부 단편화를 해결할 수 있다.

단 알고리즘 특성 상 내부 단편화에 취약한데, 이 부분을 살펴본다.

<br>

버디 블록 알고리즘은 두 블록을 결합하여 단편화를 줄이고자 하는 알고리즘으로, 기본 흐름은 아래와 같다.

<br>

![image](https://user-images.githubusercontent.com/52172169/203922379-df6ff1bf-ab0f-4db2-9c5e-48f1f297b71b.png)

<br>

예를 들어, 8KB 메모리 공간이 있고 1KB 만큼 요청을 하면 아래와 같이 최초에는 8KB 블록이었지만 1KB 블록으로 나뉘어져 할당해주게 된다.

<br>

![image](https://user-images.githubusercontent.com/52172169/203923037-df527cd6-37ba-4a07-9e57-12f9455f26c8.png)

<br>

하지만 문제점은 할당 공간이 너무 규칙적이며 만약 1.1, 4.8 이런식으로 요청이 들어온다면 애매해진다.

즉, 요청된 공간보다 더 큰 공간을 할당해줘야 하며 낭비되는 공간이 발생하게 되고 이런 낭비되는 공간을 **내부 단편화**라고 한다.

다른 말로는 외부 조각, 내부 조각이라고도 일컫는다.

<br>

해결 방법은 p.879에 설명되어 있는데 요약하면 코드 상에서 최대한 버디 블록 크기에 맞게 할당해주게 한 다는 것이다.

즉, 동적 메모리 할당한다는 의미

<br><br>
<hr style="border: 2px solid;">
<br><br>

## 알고리즘 구현

<br>

동적 메모리로 사용할 영역을 정해야 하는데, 아래 사진처럼 17MB ~ 3GB 영역을 사용할 것이다.

동적 메모리 영역은 많을수록 다양한 작업을 처리할 수 있으며, 3GB까지 설정한 이유는 3GB 이후에 비디오 레지스터, 특수 레지스터가 존재하기 때문이다.

<br>

![image](https://user-images.githubusercontent.com/52172169/203925763-777b8a27-f8d3-4207-95ec-067c79056866.png)

<br>

설계 부분부터는 p.881에서부터 복습 (이해 못함)

비트맵으로 블록의 위치를 찾을 것이며, 비트맵은 1비트에 블록 한개씩 연결한 것으로 비트 값이 1이면 블록이 할당된거를 뜻한다.

<br>

![image](https://user-images.githubusercontent.com/52172169/203929225-7fcb959b-0d95-4b44-878c-95f184bc167c.png)

<br>

구현하는 부분은 너무 이해가 안되서 일단 넘어가고 추후에 os 1권을 마무리하면 다시 공부

<br><br>
<hr style="border: 2px solid;">
<br><br>

## 빌드

<br>

![image](https://user-images.githubusercontent.com/52172169/203982398-c1fa01dc-7390-4e09-800b-e94196b4c843.png)


<br><br>
<hr style="border: 2px solid;">
<br><br>
